<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨ ØªÙØ¹ÙŠÙ„ - Hacker Mode</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="toast" class="custom-toast">
        <span id="toastIcon">âš ï¸</span>
        <span id="toastMessage">ØªÙ†Ø¨ÙŠÙ‡</span>
    </div>

    <div class="container wide-mode">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯ ØªØµØ±ÙŠØ­ Ø¬Ø¯ÙŠØ¯</h2>
        
        <label class="title">>> Ø§Ø®ØªØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</label>
        <div class="program-grid">
            <div class="program-option" onclick="selectProgram('1x', this)">
                <img src="1x.png" class="program-icon" alt="1xBet">
            </div>
            
            <div class="program-option" onclick="selectProgram('m', this)">
                <img src="m.png" class="program-icon" alt="Melbet">
            </div>
            
            <div class="program-option" onclick="selectProgram('l', this)">
                <img src="l.png" class="program-icon" alt="Linebet">
            </div>
        </div>

        <label class="title">>> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ù„Ø¨Ø±ÙŠØ¯ & ID):</label>
        <textarea id="userData" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù‡Ù†Ø§..."></textarea>

        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
                <label class="title">>> Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
                <label for="regProof" class="upload-box" id="regBox">
                    <span id="regText">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...</span>
                    <span>ğŸ“‚</span>
                    <input type="file" id="regProof" accept="image/*" onchange="handleFileSelect(this, 'regBox', 'regText')">
                </label>
            </div>
            <div style="flex: 1; min-width: 250px;">
                <label class="title">>> Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:</label>
                <label for="depProof" class="upload-box" id="depBox">
                    <span id="depText">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...</span>
                    <span>ğŸ’°</span>
                    <input type="file" id="depProof" accept="image/*" onchange="handleFileSelect(this, 'depBox', 'depText')">
                </label>
            </div>
        </div>

        <button id="submitBtn">Ø­Ù‚Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
        
        <div id="codeDisplay" class="hidden" style="margin-top: 30px; border-top: 2px dashed #333; padding-top: 20px;">
            <p style="color:var(--hacker-green);">>> ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ø§ØªØ¬:</p>
            <div style="background:#000; padding:15px; border:2px solid var(--hacker-green); margin:15px 0; font-size:2rem; font-weight:900; letter-spacing:3px; font-family:'Fira Code';" id="generatedCode"></div>
            <button class="secondary-btn" onclick="window.location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
        const SUPABASE_URL = 'https://zflgifemhopabfzgczgs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_9xZcd3BkgL6cEQwHJitrew_mbX74lJW';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram
        const TELEGRAM_TOKEN = '8362386006:AAF8yKWrs7LCKva6zcu379Vn-vma1xbjF1s';
        const ADMIN_CHAT_ID = '8114406682';

        let selectedProgram = null;

        function showToast(msg, type='error') {
            const t = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            t.style.borderColor = type === 'success' ? '#0f0' : '#f00';
            t.className = 'custom-toast show';
            setTimeout(() => t.classList.remove('show'), 4000);
        }

        function handleFileSelect(input, boxId, textId) {
            if(input.files[0]) {
                document.getElementById(boxId).classList.add('uploaded');
                document.getElementById(textId).innerText = "ØªÙ… Ø§Ù„Ø±ÙØ¹: " + input.files[0].name;
            }
        }

        function selectProgram(name, el) {
            selectedProgram = name;
            document.querySelectorAll('.program-option').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
        }

        async function uploadImage(file) {
            const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
            const { error } = await _supabase.storage.from('proofs').upload(fileName, file);
            if(error) throw error;
            const { data } = _supabase.storage.from('proofs').getPublicUrl(fileName);
            return data.publicUrl;
        }

        // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ---
        async function sendToTelegram(program, data, code, regUrl, depUrl) {
            const apiUrl = `https://api.telegram.org/bot${TELEGRAM_TOKEN}`;
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØµÙŠØ©
            const message = `
ğŸš¨ <b>Ø·Ù„Ø¨ ØªÙØ¹ÙŠÙ„ Ø¬Ø¯ÙŠØ¯!</b> ğŸš¨

ğŸ’» <b>Ø§Ù„Ù†Ø¸Ø§Ù…:</b> ${program}
ğŸ‘¤ <b>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</b>
${data}

ğŸ”‘ <b>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆÙ„Ø¯:</b> <code>${code}</code>

---------------------------
ğŸ“¸ <i>ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¢Ù†...</i>
            `;

            try {
                // 1. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ
                await fetch(`${apiUrl}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: ADMIN_CHAT_ID,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });

                // 2. Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                await fetch(`${apiUrl}/sendPhoto`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: ADMIN_CHAT_ID,
                        photo: regUrl,
                        caption: "ğŸ“‚ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„"
                    })
                });

                // 3. Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹
                await fetch(`${apiUrl}/sendPhoto`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: ADMIN_CHAT_ID,
                        photo: depUrl,
                        caption: "ğŸ’° Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹"
                    })
                });

            } catch (error) {
                console.error("Telegram Error:", error);
                // Ù„Ù† Ù†ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…ØŒ Ø§Ù„Ù…Ù‡Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            }
        }

        async function runSubmit() {
            const userData = document.getElementById('userData').value;
            const regFile = document.getElementById('regProof').files[0];
            const depFile = document.getElementById('depProof').files[0];
            const btn = document.getElementById('submitBtn');

            if(!selectedProgram) { showToast("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬"); return; }
            if(!userData) { showToast("Ø®Ø·Ø£: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©"); return; }
            if(!regFile || !depFile) { showToast("Ø®Ø·Ø£: Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù†Ø§Ù‚ØµØ©"); return; }

            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
            btn.disabled = true;

            try {
                // 1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù„Ù€ Supabase
                const regUrl = await uploadImage(regFile);
                const depUrl = await uploadImage(depFile);
                const code = 'CODE-' + Math.floor(100000 + Math.random() * 900000);
                
                // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const fullData = `Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±: [ ${selectedProgram} ]\n${userData}`;

                // 3. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹Ø´Ø§Ù† ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†)
                await _supabase.from('requests').insert([{ user_data: fullData, reg_proof_url: regUrl, dep_proof_url: depUrl, generated_code: code }]);
                await _supabase.from('active_codes').insert([{ code: code }]);

                // 4. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¨ÙˆØª (Ø§Ù„Ø¬Ø¯ÙŠØ¯)
                // Ù†Ø±Ø³Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØ¹Ø·Ù„Ø´ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                sendToTelegram(selectedProgram, userData, code, regUrl, depUrl);

                // 5. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
                showToast("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ¥Ø¨Ù„Ø§Øº Ø§Ù„Ø£Ø¯Ù…Ù†", "success");
                document.getElementById('codeDisplay').classList.remove('hidden');
                document.getElementById('generatedCode').innerText = code;
                btn.style.display = 'none';
                
            } catch (e) {
                console.error(e);
                showToast("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
                btn.innerText = "Ø­Ù‚Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯";
                btn.disabled = false;
            }
        }
        document.getElementById('submitBtn').addEventListener('click', runSubmit);
    </script>
</body>
</html>
