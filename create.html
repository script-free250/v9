<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨ ØªÙØ¹ÙŠÙ„</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="toast" class="custom-toast"><span id="toastMessage"></span></div>
    <div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div><div id="loadingText" style="color:#0f0;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div></div>

    <div class="container wide-mode" id="mainContainer" style="display:none;"> <h2 id="typewriterTitle"></h2>
        
        <label class="title">>> Ø§Ø®ØªØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</label>
        <div class="program-grid">
            <div class="program-option" onclick="selectProgram('1x', this)"><img src="1x.png" class="program-icon"></div>
            <div class="program-option" onclick="selectProgram('m', this)"><img src="m.png" class="program-icon"></div>
            <div class="program-option" onclick="selectProgram('l', this)"><img src="l.png" class="program-icon"></div>
        </div>

        <label class="title">>> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
        <textarea id="userData" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ§Ù„Ø¢ÙŠØ¯ÙŠ..."></textarea>

        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
                <label class="title">>> Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
                <label for="regProof" class="upload-box" id="regBox">
                    <div style="z-index:1"><span id="regText">Ø±ÙØ¹</span> ğŸ“‚</div>
                    <img id="regPreview" class="preview-img">
                    <input type="file" id="regProof" accept="image/*" onchange="handleFileSelect(this, 'regBox', 'regText', 'regPreview')">
                </label>
            </div>
            <div style="flex: 1; min-width: 250px;">
                <label class="title">>> Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:</label>
                <label for="depProof" class="upload-box" id="depBox">
                    <div style="z-index:1"><span id="depText">Ø±ÙØ¹</span> ğŸ’°</div>
                    <img id="depPreview" class="preview-img">
                    <input type="file" id="depProof" accept="image/*" onchange="handleFileSelect(this, 'depBox', 'depText', 'depPreview')">
                </label>
            </div>
        </div>

        <button id="submitBtn">Ø­Ù‚Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
        
        <div id="codeDisplay" class="hidden" style="margin-top: 30px; border-top: 2px dashed #333; padding-top: 20px;">
            <p style="color:var(--hacker-green);">>> ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­:</p>
            <div style="background:#000; padding:15px; border:2px solid var(--hacker-green); margin:15px 0; font-size:2rem; font-weight:900; letter-spacing:3px; font-family:'Fira Code';" id="generatedCode"></div>
            <button class="action-btn" onclick="navigator.clipboard.writeText(document.getElementById('generatedCode').innerText); alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®')">ğŸ“‹ Ù†Ø³Ø®</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://zflgifemhopabfzgczgs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_9xZcd3BkgL6cEQwHJitrew_mbX74lJW';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const TELEGRAM_TOKEN = '8362386006:AAF8yKWrs7LCKva6zcu379Vn-vma1xbjF1s';
        const ADMIN_CHAT_ID = '8114406682';

        let userIP = "Unknown";

        // === ÙØ­Øµ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ===
        async function checkBan() {
            document.getElementById('loadingOverlay').classList.add('active');
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                userIP = data.ip;

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const { data: banned } = await _supabase.from('banned_ips').select('*').eq('ip', userIP);
                
                if (banned && banned.length > 0) {
                    document.body.innerHTML = `
                        <div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#000;color:red;flex-direction:column;text-align:center;">
                            <h1 style="font-size:4rem;">ğŸš« ACCESS DENIED</h1>
                            <p style="font-family:'Fira Code'; font-size:1.5rem;">YOUR IP HAS BEEN BANNED</p>
                            <p style="color:#555;">${userIP}</p>
                        </div>
                    `;
                } else {
                    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„
                    document.getElementById('loadingOverlay').classList.remove('active');
                    document.getElementById('mainContainer').style.display = 'block';
                    typeWriter("Ø¥Ø¹Ø¯Ø§Ø¯ ØªØµØ±ÙŠØ­ Ø¬Ø¯ÙŠØ¯ //", "typewriterTitle");
                }
            } catch (e) {
                console.error("IP Check Failed", e);
                // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„ÙØ­ØµØŒ Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø£Ùˆ Ù†Ù…Ù†Ø¹Ù‡ Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ (Ù‡Ù†Ø§ Ù†Ø³Ù…Ø­)
                document.getElementById('loadingOverlay').classList.remove('active');
                document.getElementById('mainContainer').style.display = 'block';
            }
        }
        window.onload = checkBan;

        // Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù†ÙØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚)
        function typeWriter(text, elementId) {
            let i = 0; const target = document.getElementById(elementId); target.innerHTML = "";
            function type() { if (i < text.length) { target.innerHTML += text.charAt(i); i++; setTimeout(type, 50); } }
            type();
        }
        function handleFileSelect(input, boxId, textId, previewId) {
            if(input.files[0]) {
                const file = input.files[0];
                document.getElementById(boxId).classList.add('uploaded');
                document.getElementById(textId).innerText = "ØªÙ…";
                const reader = new FileReader();
                reader.onload = e => { const img = document.getElementById(previewId); img.src = e.target.result; img.style.display = "block"; }
                reader.readAsDataURL(file);
            }
        }
        let selectedProgram = null;
        function selectProgram(name, el) { selectedProgram = name; document.querySelectorAll('.program-option').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); }
        async function uploadImage(file) {
            const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
            const { error } = await _supabase.storage.from('proofs').upload(fileName, file);
            if(error) throw error;
            const { data } = _supabase.storage.from('proofs').getPublicUrl(fileName);
            return data.publicUrl;
        }
        async function runSubmit() {
            const userData = document.getElementById('userData').value;
            const regFile = document.getElementById('regProof').files[0];
            const depFile = document.getElementById('depProof').files[0];
            const btn = document.getElementById('submitBtn');

            if(!selectedProgram || !userData || !regFile || !depFile) { alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!"); return; }

            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©..."; btn.disabled = true;

            try {
                const regUrl = await uploadImage(regFile);
                const depUrl = await uploadImage(depFile);
                const code = 'CODE-' + Math.floor(100000 + Math.random() * 900000);
                const fullData = `Ø§Ù„Ù†Ø¸Ø§Ù…: [${selectedProgram}] | IP: ${userIP}\n${userData}`;

                await _supabase.from('requests').insert([{ user_data: fullData, reg_proof_url: regUrl, dep_proof_url: depUrl, generated_code: code }]);
                await _supabase.from('active_codes').insert([{ code: code }]);

                // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
                const apiUrl = `https://api.telegram.org/bot${TELEGRAM_TOKEN}`;
                const msg = `ğŸš¨ <b>Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!</b>\nğŸŒ <b>IP:</b> ${userIP}\nğŸ’» <b>${selectedProgram}</b>\n${userData}\nğŸ”‘ <code>${code}</code>`;
                fetch(`${apiUrl}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, text: msg, parse_mode: 'HTML' }) });
                fetch(`${apiUrl}/sendPhoto`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, photo: regUrl }) });
                fetch(`${apiUrl}/sendPhoto`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, photo: depUrl }) });

                document.getElementById('codeDisplay').classList.remove('hidden');
                document.getElementById('generatedCode').innerText = code;
                btn.style.display = 'none';
            } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„"); btn.disabled = false; }
        }
        document.getElementById('submitBtn').addEventListener('click', runSubmit);
    </script>
</body>
</html>
