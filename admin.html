<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (ROOT)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .container { max-width: 1000px; }
        .profit-badge { background: gold; color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .audit-log-box { background: #050505; border: 1px solid #333; height: 150px; overflow-y: scroll; font-family: 'Fira Code'; font-size: 0.8rem; color: #aaa; padding: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="confirmTitle">[ CONFIRM_ACTION ]</div>
            <div class="modal-msg" id="confirmMsg">...</div>
            <div class="modal-actions">
                <button class="modal-btn" id="confirmOkBtn">Ù†Ø¹Ù…</button>
                <button class="modal-btn cancel" onclick="closeConfirm()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <div id="alertModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="alertTitle">[ ADMIN_MSG ]</div>
            <div class="modal-msg" id="alertMsg">...</div>
            <div class="modal-actions"><button class="modal-btn" onclick="closeAlert()">Ù…ÙˆØ§ÙÙ‚</button></div>
        </div>
    </div>

    <div class="container">
        <div id="adminLogin">
            <h2 id="typewriterTitle"></h2>
            <input type="email" id="adminEmail" placeholder="USER_ID">
            <input type="password" id="adminPass" placeholder="PASSPHRASE">
            <button id="authBtn" onclick="playSound('click')">ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="adminPanel" class="hidden">
            <div class="stats-grid">
                <div class="stat-card"><span class="stat-number" id="totalCount">0</span><span class="stat-label">Ø·Ù„Ø¨Ø§Øª</span></div>
                <div class="stat-card" style="border-color: gold;"><span class="stat-number" id="totalMoney" style="color:gold;">$0</span><span class="stat-label">Ø£Ø±Ø¨Ø§Ø­</span></div>
                <div class="stat-card" style="border-color: var(--danger-red);"><span class="stat-number" id="bannedCount" style="color:var(--danger-red);">0</span><span class="stat-label">Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</span></div>
            </div>

            <div class="admin-controls">
                <input type="text" id="searchInput" class="search-input" placeholder="Ø¨Ø­Ø« (ID / ÙƒÙˆØ¯ / Ø§Ø³Ù…)..." onkeyup="filterRequests()">
                <button class="filter-btn active" onclick="setFilter('all', this)">Ø§Ù„ÙƒÙ„</button>
                <button class="filter-btn" onclick="setFilter('pending', this)">Ù…Ø¹Ù„Ù‚</button>
                <button class="filter-btn" onclick="setFilter('active', this)">Ù…ÙØ¹Ù„</button>
            </div>

            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:15px;">
                <h3 style="margin:0; color:#fff;">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©</h3>
                <button onclick="playSound('click'); loadData()" style="width:auto; margin:0; font-size:0.9rem; background:transparent; border:1px solid #555; color:#fff;">ØªØ­Ø¯ÙŠØ« â†»</button>
            </div>
            <div id="requestsList" style="text-align: right;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
            
            <h3 style="color:#666; font-size:0.9rem; margin-top:20px;">System Audit Log:</h3>
            <div id="auditLog" class="audit-log-box">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) { if (audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); if (type === 'click') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); osc.start(); osc.stop(audioCtx.currentTime + 0.05); } }
        function typeWriter(text, elementId) { let i = 0; const target = document.getElementById(elementId); target.innerHTML = ""; function type() { if (i < text.length) { target.innerHTML += text.charAt(i); i++; setTimeout(type, 50); } } type(); }
        window.onload = () => typeWriter("Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù (ROOT)", "typewriterTitle");

        function showAlert(title, msg) { document.getElementById('alertTitle').innerText = title; document.getElementById('alertMsg').innerText = msg; document.getElementById('alertModal').classList.add('active'); }
        function closeAlert() { document.getElementById('alertModal').classList.remove('active'); }
        let confirmCallback = null;
        function showConfirm(title, msg, callback) { document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmMsg').innerText = msg; confirmCallback = callback; document.getElementById('confirmModal').classList.add('active'); }
        function closeConfirm() { document.getElementById('confirmModal').classList.remove('active'); }
        document.getElementById('confirmOkBtn').onclick = () => { if(confirmCallback) confirmCallback(); closeConfirm(); };

        const SUPABASE_URL = 'https://zflgifemhopabfzgczgs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_9xZcd3BkgL6cEQwHJitrew_mbX74lJW';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allRequests = [];
        let currentFilter = 'all';

        document.getElementById('authBtn').addEventListener('click', () => {
            const e = document.getElementById('adminEmail').value; const p = document.getElementById('adminPass').value;
            if(e === "mm@mm.mm" && p === "mm023123") { document.getElementById('adminLogin').classList.add('hidden'); document.getElementById('adminPanel').classList.remove('hidden'); loadData(); loadAuditLog(); } else { showAlert("âŒ Ø®Ø·Ø£", "Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!"); }
        });

        async function logAction(action) {
            // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ audit_logs (ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¤Ù‡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            const time = new Date().toISOString();
            const logEntry = `[${time}] ADMIN: ${action}`;
            await _supabase.from('audit_logs').insert([{ log: logEntry }]);
            loadAuditLog();
        }

        async function activateCode(code, reqId) {
            // Ø·Ù„Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
            let profit = prompt("ğŸ’° Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ø¨Ø­ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø£Ùˆ Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©):", "0");
            if (profit === null) return; // Cancelled

            showConfirm("ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯", `ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØªØ³Ø¬ÙŠÙ„ Ø±Ø¨Ø­ ${profit}ØŸ`, async () => {
                // 1. ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
                const { error } = await _supabase.from('active_codes').update({ is_active: true }).eq('code', code);
                // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¨Ø­ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ù…ÙˆØ¯ profit ÙÙŠ Ø¬Ø¯ÙˆÙ„ requests)
                await _supabase.from('requests').update({ profit: profit, status: 'active' }).eq('id', reqId);
                
                if(error) showAlert("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„."); 
                else {
                    logAction(`Activated code ${code} - Profit: ${profit}`);
                    showAlert("Ù†Ø¬Ø§Ø­ âœ…", "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø¨Ø­.");
                    loadData();
                }
            });
        }

        async function banUser(ip) { showConfirm("Ø­Ø¸Ø± IP", `Ø­Ø¸Ø± ${ip} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`, async () => { const { error } = await _supabase.from('banned_ips').insert([{ ip: ip }]); logAction(`Banned IP ${ip}`); if(error) showAlert("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø­Ø¸Ø±."); else { showAlert("ØªÙ…", "ØªÙ… Ø§Ù„Ø­Ø¸Ø± ğŸš«"); loadData(); } }); }
        async function deleteRequest(id) { showConfirm("Ø­Ø°Ù", "Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ", async () => { await _supabase.from('requests').delete().eq('id', id); logAction(`Deleted Request ID ${id}`); loadData(); }); }

        function setFilter(type, btn) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderList();
        }

        function filterRequests() { renderList(); }

        async function loadAuditLog() {
            const { data } = await _supabase.from('audit_logs').select('*').order('created_at', {ascending:false}).limit(20);
            const logBox = document.getElementById('auditLog');
            if(data) logBox.innerHTML = data.map(l => `<div>${l.log}</div>`).join('');
        }

        async function loadData() {
            const list = document.getElementById('requestsList'); list.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø¨Ø­
            const { data: requests } = await _supabase.from('requests').select('*').order('created_at', {ascending:false});
            const { count: bannedCount } = await _supabase.from('banned_ips').select('*', { count: 'exact', head: true });

            if(requests) {
                allRequests = requests;
                // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
                let totalMoney = 0;
                requests.forEach(r => { if(r.profit) totalMoney += parseFloat(r.profit); });
                
                document.getElementById('totalCount').innerText = requests.length;
                document.getElementById('totalMoney').innerText = "$" + totalMoney;
                document.getElementById('bannedCount').innerText = bannedCount || 0;
                
                renderList();
            } else { list.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</p>'; }
        }

        function renderList() {
            const list = document.getElementById('requestsList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            list.innerHTML = '';

            const filtered = allRequests.filter(r => {
                const matchesSearch = r.user_data.toLowerCase().includes(search) || r.generated_code.toLowerCase().includes(search);
                const isActive = r.status === 'active'; // Ù†ÙØªØ±Ø¶ ÙˆØ¬ÙˆØ¯ Ø¹Ù…ÙˆØ¯ status Ø£Ùˆ ÙŠØªÙ… Ø§Ø³ØªÙ†ØªØ§Ø¬Ù‡
                if (currentFilter === 'active' && !isActive) return false;
                if (currentFilter === 'pending' && isActive) return false;
                return matchesSearch;
            });

            filtered.forEach(r => {
                const ipMatch = r.user_data.match(/IP: ([\d\.]+)/);
                const userIP = ipMatch ? ipMatch[1] : 'Unknown';
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²
                const deviceMatch = r.user_data.match(/Device: (\w+)/);
                const device = deviceMatch ? deviceMatch[1] : 'Unknown';
                const deviceIcon = device === 'Mobile' ? 'ğŸ“±' : (device === 'Desktop' ? 'ğŸ’»' : 'ğŸ“Ÿ');
                
                const d = new Date(r.created_at).toLocaleString('ar-EG');
                const profitDisplay = r.profit ? `<span class="profit-badge">+$${r.profit}</span>` : '';

                const div = document.createElement('div');
                div.style.cssText = "background:#050505; border:1px solid #333; padding:20px; margin-bottom:15px; border-right: 4px solid " + (r.status==='active'?'gold':'#0f0') + ";";
                div.innerHTML = `
                    <div style="color:#666; font-size:0.8rem; margin-bottom:10px; font-family:'Fira Code'; display:flex; justify-content:space-between;">
                        <span>${d}</span>
                        <span style="color:#fff;">${deviceIcon} ${userIP}</span>
                    </div>
                    <div style="background:#111; padding:15px; white-space:pre-wrap; color:#fff; margin-bottom:10px;">${r.user_data}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <p>Ø§Ù„ÙƒÙˆØ¯: <span style="color:#0f0; font-weight:bold; font-family:'Fira Code'; font-size:1.2rem;">${r.generated_code}</span></p>
                        ${profitDisplay}
                    </div>
                    <div style="display:flex; gap:10px; margin-top:15px; flex-wrap:wrap;">
                        <a href="${r.reg_proof_url}" target="_blank"><img src="${r.reg_proof_url}" height="60" style="border:1px solid #555"></a>
                        <a href="${r.dep_proof_url}" target="_blank"><img src="${r.dep_proof_url}" height="60" style="border:1px solid #555"></a>
                    </div>
                    <div style="margin-top:15px; border-top:1px dashed #333; padding-top:10px;">
                        <button class="action-btn activate-btn" onclick="activateCode('${r.generated_code}', ${r.id})">âœ… ØªÙØ¹ÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø±Ø¨Ø­</button>
                        <button class="action-btn ban-btn" onclick="banUser('${userIP}')">ğŸš« Ø­Ø¸Ø±</button>
                        <button class="action-btn delete-btn" onclick="deleteRequest(${r.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>
